version: '3.8'

# ═══════════════════════════════════════════════════════════════
# Eclipse Ditto — Digital Twin Platform for IoV Task Allocation
# ═══════════════════════════════════════════════════════════════
# Start:  docker-compose up -d
# Stop:   docker-compose down
# Status: docker-compose ps
# Logs:   docker-compose logs -f
# ═══════════════════════════════════════════════════════════════

services:

  # ── MongoDB (persistence for Ditto) ──
  mongodb:
    image: mongo:6.0
    container_name: ditto-mongodb
    ports:
      - "27017:27017"
    volumes:
      - ditto-mongo-data:/data/db
    restart: unless-stopped

  # ── Eclipse Ditto: Policies ──
  policies:
    image: eclipse/ditto-policies:3.4.3
    container_name: ditto-policies
    depends_on:
      - mongodb
    environment:
      - MONGO_DB_URI=mongodb://mongodb:27017/policies
      - JAVA_TOOL_OPTIONS=-Xmx256m -Xms128m
    restart: unless-stopped

  # ── Eclipse Ditto: Things ──
  things:
    image: eclipse/ditto-things:3.4.3
    container_name: ditto-things
    depends_on:
      - mongodb
      - policies
    environment:
      - MONGO_DB_URI=mongodb://mongodb:27017/things
      - JAVA_TOOL_OPTIONS=-Xmx256m -Xms128m
    restart: unless-stopped

  # ── Eclipse Ditto: Things Search ──
  things-search:
    image: eclipse/ditto-things-search:3.4.3
    container_name: ditto-things-search
    depends_on:
      - mongodb
      - policies
      - things
    environment:
      - MONGO_DB_URI=mongodb://mongodb:27017/things-search
      - JAVA_TOOL_OPTIONS=-Xmx256m -Xms128m
    restart: unless-stopped

  # ── Eclipse Ditto: Connectivity ──
  connectivity:
    image: eclipse/ditto-connectivity:3.4.3
    container_name: ditto-connectivity
    depends_on:
      - mongodb
      - policies
      - things
    environment:
      - MONGO_DB_URI=mongodb://mongodb:27017/connectivity
      - JAVA_TOOL_OPTIONS=-Xmx256m -Xms128m
    restart: unless-stopped

  # ── Eclipse Ditto: Gateway (API) ──
  gateway:
    image: eclipse/ditto-gateway:3.4.3
    container_name: ditto-gateway
    depends_on:
      - policies
      - things
      - things-search
      - connectivity
    environment:
      - JAVA_TOOL_OPTIONS=-Xmx256m -Xms128m
      - ENABLE_DUMMY_AUTH=true
    restart: unless-stopped

  # ── Nginx (reverse proxy — exposes Ditto API on port 8080) ──
  nginx:
    image: nginx:1.25-alpine
    container_name: ditto-nginx
    depends_on:
      - gateway
    ports:
      - "8080:80"
    volumes:
      - ./ditto/nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

volumes:
  ditto-mongo-data:
